<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</title>
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #f0f2f5; margin: 0; padding: 20px; }
        .card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        .hidden { display: none !important; }
        .error { color: #e74c3c; margin-top: 15px; font-size: 14px; min-height: 20px; }
        .success { color: #27ae60; font-weight: bold; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 15px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #user-avatar { width: 80px; height: 80px; border-radius: 50%; margin: 10px auto; display: block; }
        button { background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 15px; }
        button:hover { background: #c0392b; }
    </style>
</head>
<body>

<div class="card">
    <h2>–í—Ö–æ–¥</h2>
    
    <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ —Å –∫–Ω–æ–ø–∫–æ–π Google -->
    <div id="login-section">
        <div id="g_id_onload"
             data-client_id="461200840639-bup0mjs0lji7cr1lbbd49poc2t78ua4n.apps.googleusercontent.com"
             data-callback="handleGoogleResponse"
             data-auto_prompt="false">
        </div>
        <div class="g_id_signin"
             data-type="standard"
             data-size="large"
             data-theme="outline"
             data-text="signin_with"
             data-shape="rectangular"
             data-logo_alignment="left">
        </div>
        
        <div class="loader hidden" id="loader"></div>
        <div class="error" id="error-msg"></div>
    </div>

    <!-- –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ -->
    <div id="success-section" class="hidden">
        <p class="success">‚úì –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à—ë–Ω</p>
        <img id="user-avatar" src="" alt="Avatar">
        <p><strong id="user-name"></strong></p>
        <p id="user-email" style="color:#666; font-size:14px;"></p>
        <button onclick="logout()">–í—ã–π—Ç–∏</button>
    </div>
</div>

<script>
    // üî• –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –°–°–´–õ–ö–£ –ù–ê –í–ê–® APPS SCRIPT (–∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ —à–∞–≥–∞)
    const SCRIPT_URL = 'https://script.google.com/macros/s/–í–ê–®_–°–ö–†–ò–ü–¢/exec';

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –æ—Ç Google
    function handleGoogleResponse(response) {
        // –î–µ–∫–æ–¥–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω (payload - –≤—Ç–æ—Ä–∞—è —á–∞—Å—Ç—å)
        const userInfo = JSON.parse(atob(response.credential.split('.')[1]));
        const email = userInfo.email;
        
        document.getElementById('loader').classList.remove('hidden');
        document.getElementById('error-msg').textContent = '';
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º email –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –≤ Google –¢–∞–±–ª–∏—Ü—É
        fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'checkAccess', email: email })
        })
        .then(res => res.json())
        .then(data => {
            document.getElementById('loader').classList.add('hidden');
            
            if (data.success) {
                showSuccess(userInfo);
            } else {
                document.getElementById('error-msg').textContent = '‚ùå ' + data.message;
            }
        })
        .catch(err => {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('error-msg').textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
            console.error(err);
        });
    }

    function showSuccess(user) {
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('success-section').classList.remove('hidden');
        document.getElementById('user-name').textContent = user.name;
        document.getElementById('user-email').textContent = user.email;
        document.getElementById('user-avatar').src = user.picture;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        localStorage.setItem('authUser', JSON.stringify(user));
    }

    function logout() {
        localStorage.removeItem('authUser');
        // –°–±—Ä–æ—Å —Å–µ—Å—Å–∏–∏ Google (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        if (window.google?.accounts?.id) {
            google.accounts.id.disableAutoSelect();
        }
        location.reload();
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ: –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
    window.onload = function() {
        const saved = localStorage.getItem('authUser');
        if (saved) {
            try {
                const user = JSON.parse(saved);
                showSuccess(user);
            } catch(e) {
                localStorage.removeItem('authUser');
            }
        }
    };
</script>

</body>
</html>
