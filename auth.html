<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; }
        .card { background: white; padding: 40px 30px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); width: 100%; max-width: 420px; text-align: center; }
        .card h2 { margin-bottom: 25px; color: #333; }
        #g_id_onload { display: none; }
        .g_id_signin { margin: 0 auto; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 28px; height: 28px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error { color: #e74c3c; margin-top: 15px; font-size: 14px; min-height: 20px; line-height: 1.4; }
        .success { color: #27ae60; font-weight: 600; margin-bottom: 10px; }
        .hidden { display: none !important; }
        #user-avatar { width: 90px; height: 90px; border-radius: 50%; margin: 15px auto; display: block; border: 3px solid #667eea; object-fit: cover; }
        #user-name { font-size: 18px; font-weight: 600; color: #333; margin: 10px 0 5px; }
        #user-email { color: #666; font-size: 14px; margin-bottom: 20px; word-break: break-all; }
        button { background: #e74c3c; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: background 0.2s; }
        button:hover { background: #c0392b; }
        .footer { margin-top: 25px; font-size: 12px; color: #999; }
        .footer a { color: #667eea; text-decoration: none; }
    </style>
</head>
<body>

<div class="card">
    <h2>üîê –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
    
    <div id="login-section">
        <div id="g_id_onload"
             data-client_id="461200840639-bup0mjs0lji7cr1lbbd49poc2t78ua4n.apps.googleusercontent.com"
             data-callback="handleGoogleResponse"
             data-auto_prompt="false"
             data-ux_mode="popup">
        </div>
        <div class="g_id_signin"
             data-type="standard" data-size="large" data-theme="outline"
             data-text="signin_with" data-shape="rectangular" data-logo_alignment="left">
        </div>
        <div class="loader hidden" id="loader"></div>
        <div class="error" id="error-msg"></div>
    </div>

    <div id="success-section" class="hidden">
        <p class="success">‚úì –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à—ë–Ω</p>
        <img id="user-avatar" src="" alt="Avatar">
        <div id="user-name"></div>
        <div id="user-email"></div>
        <button onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
    </div>
    
    <div class="footer">
        –ó–∞—â–∏—â–µ–Ω–æ Google OAuth ‚Ä¢ 
        <a href="https://fidan977.github.io" target="_blank">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
    </div>
</div>

<script>
    // üî• –í–ê–®–ê –°–°–´–õ–ö–ê –ù–ê APPS SCRIPT (—É–∂–µ –≤—Å—Ç–∞–≤–ª–µ–Ω–∞)
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbymAmhs0R4P9_nRD6_SFyi62re6mB5Qvfzbq3Ti36zyZMjEShGvElIZFm0Dae4YrVgXcQ/exec';

    function handleGoogleResponse(response) {
        const idToken = response.credential;
        
        document.getElementById('loader').classList.remove('hidden');
        document.getElementById('error-msg').textContent = '';
        document.querySelector('.g_id_signin').style.opacity = '0.6';
        document.querySelector('.g_id_signin').style.pointerEvents = 'none';
        
        // üîê –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —á–µ—Ä–µ–∑ URL-encoded (–Ω–µ JSON!)
        const params = new URLSearchParams();
        params.append('action', 'checkAccess');
        params.append('token', idToken);
        
        fetch(SCRIPT_URL, {
            method: 'POST',
            body: params  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ form data
            // ‚ùå –ë–µ–∑ headers: Content-Type ‚Äî –±—Ä–∞—É–∑–µ—Ä —Å–∞–º –ø–æ—Å—Ç–∞–≤–∏—Ç application/x-www-form-urlencoded
        })
        .then(res => {
            if (!res.ok) throw new Error('HTTP ' + res.status);
            return res.json();
        })
        .then(data => {
            document.getElementById('loader').classList.add('hidden');
            document.querySelector('.g_id_signin').style.opacity = '1';
            document.querySelector('.g_id_signin').style.pointerEvents = 'auto';
            
            if (data.success) {
                const userInfo = JSON.parse(atob(idToken.split('.')[1]));
                showSuccess(userInfo);
            } else {
                document.getElementById('error-msg').textContent = '‚ùå ' + (data.message || '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω');
            }
        })
        .catch(err => {
            document.getElementById('loader').classList.add('hidden');
            document.querySelector('.g_id_signin').style.opacity = '1';
            document.querySelector('.g_id_signin').style.pointerEvents = 'auto';
            document.getElementById('error-msg').textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
            console.error('Fetch error:', err);
        });
    }

    function showSuccess(user) {
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('success-section').classList.remove('hidden');
        document.getElementById('user-name').textContent = user.name;
        document.getElementById('user-email').textContent = user.email;
        document.getElementById('user-avatar').src = user.picture || 'https://via.placeholder.com/90?text=üë§';
        localStorage.setItem('authUser', JSON.stringify({ email: user.email, name: user.name, picture: user.picture, loginTime: Date.now() }));
    }

    function logout() {
        localStorage.removeItem('authUser');
        if (window.google?.accounts?.id) {
            google.accounts.id.disableAutoSelect();
        }
        location.reload();
    }

    window.onload = function() {
        const saved = localStorage.getItem('authUser');
        if (saved) {
            try {
                const user = JSON.parse(saved);
                const maxAge = 24 * 60 * 60 * 1000;
                if (Date.now() - user.loginTime < maxAge) {
                    showSuccess(user);
                    return;
                }
            } catch(e) { localStorage.removeItem('authUser'); }
        }
        if (window.google?.accounts?.id) {
            google.accounts.id.initialize({
                client_id: "461200840639-bup0mjs0lji7cr1lbbd49poc2t78ua4n.apps.googleusercontent.com",
                callback: handleGoogleResponse
            });
            google.accounts.id.renderButton(
                document.querySelector('.g_id_signin'),
                { theme: "outline", size: "large", text: "signin_with", shape: "rectangular" }
            );
        }
    };
</script>

</body>
</html>
