<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</title>
    
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        .card { 
            background: white; 
            padding: 40px 30px; 
            border-radius: 16px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); 
            width: 100%; 
            max-width: 420px; 
            text-align: center; 
        }
        .card h2 { margin-bottom: 25px; color: #333; }
        
        /* Google button container */
        #g_id_onload { display: none; }
        .g_id_signin { margin: 0 auto; }
        
        /* –ó–∞–≥—Ä—É–∑—á–∏–∫ */
        .loader { 
            border: 3px solid #f3f3f3; 
            border-top: 3px solid #667eea; 
            border-radius: 50%; 
            width: 28px; 
            height: 28px; 
            animation: spin 1s linear infinite; 
            margin: 20px auto; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .error { 
            color: #e74c3c; 
            margin-top: 15px; 
            font-size: 14px; 
            min-height: 20px;
            line-height: 1.4;
        }
        .success { 
            color: #27ae60; 
            font-weight: 600; 
            margin-bottom: 10px;
        }
        
        /* –°–µ–∫—Ü–∏–∏ */
        .hidden { display: none !important; }
        
        /* –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
        #user-avatar { 
            width: 90px; 
            height: 90px; 
            border-radius: 50%; 
            margin: 15px auto; 
            display: block; 
            border: 3px solid #667eea;
            object-fit: cover;
        }
        #user-name { font-size: 18px; font-weight: 600; color: #333; margin: 10px 0 5px; }
        #user-email { color: #666; font-size: 14px; margin-bottom: 20px; word-break: break-all; }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        button { 
            background: #e74c3c; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 500;
            transition: background 0.2s;
        }
        button:hover { background: #c0392b; }
        button:active { transform: scale(0.98); }
        
        /* Footer */
        .footer { margin-top: 25px; font-size: 12px; color: #999; }
        .footer a { color: #667eea; text-decoration: none; }
    </style>
</head>
<body>

<div class="card">
    <h2>üîê –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
    
    <!-- üîπ –°–ï–ö–¶–ò–Ø –í–•–û–î–ê -->
    <div id="login-section">
        <!-- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Google Sign-In -->
        <div id="g_id_onload"
             data-client_id="461200840639-bup0mjs0lji7cr1lbbd49poc2t78ua4n.apps.googleusercontent.com"
             data-callback="handleGoogleResponse"
             data-auto_prompt="false"
             data-ux_mode="popup">
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∞ –≤—Ö–æ–¥–∞ (—Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è —Å—é–¥–∞) -->
        <div class="g_id_signin"
             data-type="standard"
             data-size="large"
             data-theme="outline"
             data-text="signin_with"
             data-shape="rectangular"
             data-logo_alignment="left">
        </div>
        
        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div class="loader hidden" id="loader"></div>
        
        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ -->
        <div class="error" id="error-msg"></div>
    </div>

    <!-- üîπ –°–ï–ö–¶–ò–Ø –£–°–ü–ï–®–ù–û–ì–û –í–•–û–î–ê -->
    <div id="success-section" class="hidden">
        <p class="success">‚úì –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à—ë–Ω</p>
        <img id="user-avatar" src="" alt="Avatar">
        <div id="user-name"></div>
        <div id="user-email"></div>
        <button onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
    </div>
    
    <div class="footer">
        –ó–∞—â–∏—â–µ–Ω–æ Google OAuth ‚Ä¢ 
        <a href="https://fidan977.github.io" target="_blank">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
    </div>
</div>

<script>
    // üî• üî• üî• –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –í–ê–®–£ –°–°–´–õ–ö–£ –ù–ê APPS SCRIPT üî• üî• üî•
    // –î–æ–ª–∂–Ω–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è –Ω–∞ /exec
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbymAmhs0R4P9_nRD6_SFyi62re6mB5Qvfzbq3Ti36zyZMjEShGvElIZFm0Dae4YrVgXcQ/exec';

    // ============================================
    // üîÑ –û–ë–†–ê–ë–û–¢–ö–ê –û–¢–í–ï–¢–ê –û–¢ GOOGLE
    // ============================================
    function handleGoogleResponse(response) {
        const idToken = response.credential; // üîê JWT —Ç–æ–∫–µ–Ω, –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π Google
        
        // UI: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        document.getElementById('loader').classList.remove('hidden');
        document.getElementById('error-msg').textContent = '';
        document.querySelector('.g_id_signin').style.opacity = '0.6';
        document.querySelector('.g_id_signin').style.pointerEvents = 'none';
        
        // üîê –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¢–û–ö–ï–ù –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É (–Ω–µ email!)
        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                action: 'checkAccess', 
                token: idToken  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–µ—Å—å —Ç–æ–∫–µ–Ω –¥–ª—è –∫—Ä–∏–ø—Ç–æ-–ø—Ä–æ–≤–µ—Ä–∫–∏
            })
        })
        .then(res => {
            if (!res.ok) throw new Error('HTTP ' + res.status);
            return res.json();
        })
        .then(data => {
            // UI: —Å–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            document.getElementById('loader').classList.add('hidden');
            document.querySelector('.g_id_signin').style.opacity = '1';
            document.querySelector('.g_id_signin').style.pointerEvents = 'auto';
            
            if (data.success) {
                // –î–µ–∫–æ–¥–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (payload - –≤—Ç–æ—Ä–∞—è —á–∞—Å—Ç—å JWT)
                const userInfo = JSON.parse(atob(idToken.split('.')[1]));
                showSuccess(userInfo);
            } else {
                document.getElementById('error-msg').textContent = '‚ùå ' + (data.message || '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω');
            }
        })
        .catch(err => {
            document.getElementById('loader').classList.add('hidden');
            document.querySelector('.g_id_signin').style.opacity = '1';
            document.querySelector('.g_id_signin').style.pointerEvents = 'auto';
            document.getElementById('error-msg').textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12).';
            console.error('Fetch error:', err);
        });
    }

    // ============================================
    // ‚úÖ –ü–û–ö–ê–ó –£–°–ü–ï–®–ù–û–ì–û –í–•–û–î–ê
    // ============================================
    function showSuccess(user) {
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('success-section').classList.remove('hidden');
        
        document.getElementById('user-name').textContent = user.name;
        document.getElementById('user-email').textContent = user.email;
        document.getElementById('user-avatar').src = user.picture || 'https://via.placeholder.com/90?text=üë§';
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é –≤ localStorage (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        try {
            localStorage.setItem('authUser', JSON.stringify({
                email: user.email,
                name: user.name,
                picture: user.picture,
                loginTime: Date.now()
            }));
        } catch(e) { console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–µ—Å—Å–∏—é', e); }
    }

    // ============================================
    // üö™ –í–´–•–û–î –ò–ó –°–ò–°–¢–ï–ú–´
    // ============================================
    function logout() {
        // –û—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é —Å–µ—Å—Å–∏—é
        localStorage.removeItem('authUser');
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–≤—Ç–æ–≤—ã–±–æ—Ä –∞–∫–∫–∞—É–Ω—Ç–∞ Google
        if (window.google?.accounts?.id) {
            google.accounts.id.disableAutoSelect();
            google.accounts.id.revoke(localStorage.getItem('lastEmail') || '', () => {});
        }
        
        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
        location.reload();
    }

    // ============================================
    // üîÑ –ü–†–û–í–ï–†–ö–ê –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï –°–¢–†–ê–ù–ò–¶–´
    // ============================================
    window.onload = function() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è
        const saved = localStorage.getItem('authUser');
        if (saved) {
            try {
                const user = JSON.parse(saved);
                // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ –∏—Å—Ç–µ–∫–ª–∞ –ª–∏ —Å–µ—Å—Å–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 24 —á–∞—Å–∞)
                const maxAge = 24 * 60 * 60 * 1000; // 24 —á–∞—Å–∞
                if (Date.now() - user.loginTime < maxAge) {
                    showSuccess(user);
                    return;
                }
            } catch(e) {
                localStorage.removeItem('authUser');
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Google Sign-In (–µ—Å–ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å)
        if (window.google?.accounts?.id) {
            google.accounts.id.initialize({
                client_id: "461200840639-bup0mjs0lji7cr1lbbd49poc2t78ua4n.apps.googleusercontent.com",
                callback: handleGoogleResponse,
                auto_select: false
            });
            google.accounts.id.renderButton(
                document.querySelector('.g_id_signin'),
                { theme: "outline", size: "large", text: "signin_with", shape: "rectangular" }
            );
        }
    };
</script>

</body>
</html>
